import os
import asyncio
import aiohttp
import aiofiles
from typing import Union
from pyrogram import Client, filters, idle
from pyrogram.types import Message
from pyrogram.raw.functions.phone import CreateGroupCall
from pyrogram.errors import FloodWait

from pytgcalls import PyTgCalls, StreamType
from pytgcalls.exceptions import NoActiveGroupCall, AlreadyJoinedError
from pytgcalls.types.input_stream import AudioPiped, AudioVideoPiped
from pytgcalls.types import AudioQuality, VideoQuality
from pytgcalls.types import Update
from pytgcalls.types.stream import StreamAudioEnded

from youtubesearchpython.__future__ import VideosSearch
from PIL import Image, ImageDraw, ImageEnhance, ImageFilter, ImageFont

# ==========================================
# Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ø¶Ø¹ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù‡Ù†Ø§)
# ==========================================
API_ID = 25761783            # Ø¶Ø¹ API_ID Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù‡Ù†Ø§
API_HASH = "7770de22ee036afb30a99d449c51f4b8"  # Ø¶Ø¹ API_HASH Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù‡Ù†Ø§
BOT_TOKEN = "8017670938:AAGURw0_kEKdZ_bYAYKs24RedQsfkve9Aiw"  # Ø¶Ø¹ ØªÙˆÙƒÙ† Ø§Ù„Ø¨ÙˆØª Ù‡Ù†Ø§

# Ø§Ø³Ù… Ø§Ù„Ø³ÙˆØ±Ø³ Ù„Ù„ÙƒØªØ§Ø¨Ø© Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ±
SOURCE_NAME = "Caesar Music"
# Ù…Ø³Ø§Ø± Ù…Ù„Ù Ø§Ù„ÙƒÙˆÙƒÙŠØ² (Ø¶Ø±ÙˆØ±ÙŠ Ù„Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† ÙŠÙˆØªÙŠÙˆØ¨)
COOKIES_FILE = "cookies/cookies2.txt"

# ==========================================
# ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (Clients Initialization)
# ==========================================

app = Client(
    "music_bot_session",
    api_id=API_ID,
    api_hash=API_HASH,
    bot_token=BOT_TOKEN
)

call_py = PyTgCalls(app)

# ==========================================
# Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ÙˆØ§Ù„ØªØ´ØºÙŠÙ„
# ==========================================
playlist = {}   # Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ´ØºÙŠÙ„: {chat_id: [links]}
titles = {}     # Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø£ØºØ§Ù†ÙŠ: {chat_id: [titles]}
playing_now = {} # Ù…Ø§ ÙŠØªÙ… ØªØ´ØºÙŠÙ„Ù‡ Ø­Ø§Ù„ÙŠØ§Ù‹

# ==========================================
# Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© (Helpers)
# ==========================================

async def download_yt(link, video=False):
    """Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… yt-dlp Ù…Ø¹ Ø§Ù„ÙƒÙˆÙƒÙŠØ²"""
    if not os.path.exists(COOKIES_FILE):
        print(f"âš ï¸ ØªØ­Ø°ÙŠØ±: Ù…Ù„Ù Ø§Ù„ÙƒÙˆÙƒÙŠØ² ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ {COOKIES_FILE}")
    
    fmt = "bestvideo+bestaudio/best" if video else "bestaudio"
    command = [
        "yt-dlp",
        "--cookies", COOKIES_FILE,
        "-g",
        "-f", fmt,
        link
    ]
    try:
        proc = await asyncio.create_subprocess_exec(
            *command,
            stdout=asyncio.subprocess.PIPE, stderr=asyncio.subprocess.PIPE
        )
        stdout, stderr = await proc.communicate()
        if stdout:
            return stdout.decode().strip()
    except Exception as e:
        print(f"Download Error: {e}")
    return None

def changeImageSize(maxWidth, maxHeight, image):
    widthRatio = maxWidth / image.size[0]
    heightRatio = maxHeight / image.size[1]
    newWidth = int(widthRatio * image.size[0])
    newHeight = int(heightRatio * image.size[1])
    return image.resize((newWidth, newHeight))

async def gen_thumb(videoid):
    """ØªÙˆÙ„ÙŠØ¯ ØµÙˆØ±Ø© Ù…ØµØºØ±Ø©"""
    filename = f"photos/{videoid}.jpg"
    if os.path.isfile(filename):
        return filename

    url = f"https://www.youtube.com/watch?v={videoid}"
    try:
        results = VideosSearch(url, limit=1)
        res = (await results.next())["result"][0]
        thumbnail_url = res["thumbnails"][0]["url"].split("?")[0]

        async with aiohttp.ClientSession() as session:
            async with session.get(thumbnail_url) as resp:
                if resp.status == 200:
                    data = await resp.read()
                    with open(f"thumb{videoid}.png", "wb") as f:
                        f.write(data)

        image = Image.open(f"thumb{videoid}.png")
        image = changeImageSize(1280, 720, image)
        
        # ØªØ£Ø«ÙŠØ±Ø§Øª
        background = image.convert("RGBA").filter(filter=ImageFilter.BoxBlur(5))
        enhancer = ImageEnhance.Brightness(background)
        image = enhancer.enhance(0.6)
        
        # Ø§Ù„ÙƒØªØ§Ø¨Ø©
        draw = ImageDraw.Draw(image)
        try:
            font = ImageFont.truetype("arial.ttf", 60) # ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø®Ø· Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
        except:
            font = ImageFont.load_default()
            
        draw.text((40, 40), f"{SOURCE_NAME}", fill="white", font=font)
        
        if not os.path.exists("photos"):
            os.mkdir("photos")
            
        image.convert("RGB").save(filename)
        os.remove(f"thumb{videoid}.png")
        return filename
    except Exception as e:
        print(f"Thumb Error: {e}")
        return None

async def play_next(chat_id):
    """ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£ØºÙ†ÙŠØ© Ø§Ù„ØªØ§Ù„ÙŠØ© ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©"""
    if chat_id in playlist and playlist[chat_id]:
        link = playlist[chat_id].pop(0)
        title = titles[chat_id].pop(0)
        
        stream = AudioPiped(
            link,
            audio_parameters=AudioQuality.STUDIO
        )
        try:
            await call_py.change_stream(chat_id, stream)
            playing_now[chat_id] = title
        except Exception as e:
            print(f"Change Stream Error: {e}")
    else:
        try:
            await call_py.leave_group_call(chat_id)
            if chat_id in playing_now: del playing_now[chat_id]
        except: pass

# ==========================================
# Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¨ÙˆØª (Handlers)
# ==========================================

@app.on_message(filters.command(["Ø´ØºÙ„", "play"], prefixes=["/", ""]) & filters.group)
async def play_handler(client, message):
    chat_id = message.chat.id
    
    # 1. Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù†Øµ Ø§Ù„Ø¨Ø­Ø«
    if message.reply_to_message:
        query = "Ù…Ù„Ù_Ù…Ø±ÙÙ‚" # Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…Ù„ÙØ§Øª ÙŠØ­ØªØ§Ø¬ ØªØ­Ù…ÙŠÙ„ØŒ Ù‡Ù†Ø§ Ù†Ø±ÙƒØ² Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙˆØªÙŠÙˆØ¨ Ù„Ù„ØªØ¨Ø³ÙŠØ·
        await message.reply("âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø£ØºÙ†ÙŠØ© Ù…Ø¹ Ø§Ù„Ø£Ù…Ø± (Ù…Ø«Ø§Ù„: Ø´ØºÙ„ ÙÙŠØ±ÙˆØ²)")
        return
    else:
        try:
            query = message.text.split(None, 1)[1]
        except IndexError:
            return await message.reply("âŒ Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø£ØºÙ†ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„Ø£Ù…Ø± (Ù…Ø«Ø§Ù„: Ø´ØºÙ„ Ø¹Ù…Ø±Ùˆ Ø¯ÙŠØ§Ø¨)")

    msg = await message.reply("ğŸ” Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...")
    
    # 2. Ø§Ù„Ø¨Ø­Ø« ÙÙŠ ÙŠÙˆØªÙŠÙˆØ¨
    try:
        search = VideosSearch(query, limit=1)
        res = (await search.next())["result"][0]
        videoid = res["id"]
        title = res["title"]
        link = f"https://www.youtube.com/watch?v={videoid}"
        
        # 3. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
        stream_link = await download_yt(link, video=False)
        if not stream_link:
            return await msg.edit("âŒ ÙØ´Ù„ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø±Ø§Ø¨Ø·ØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ÙƒÙˆÙƒÙŠØ².")

        # 4. ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØµÙˆØ±Ø©
        thumb = await gen_thumb(videoid)

        # 5. Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø£Ùˆ Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©
        try:
            # Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù…Ø¨Ø§Ø´Ø±Ø©
            stream = AudioPiped(stream_link, audio_parameters=AudioQuality.STUDIO)
            await call_py.join_group_call(
                chat_id,
                stream,
                stream_type=StreamType().pulse_stream
            )
            playing_now[chat_id] = title
            await msg.delete()
            if thumb:
                await message.reply_photo(thumb, caption=f"âœ… **ØªÙ… Ø§Ù„ØªØ´ØºÙŠÙ„:** {title}")
            else:
                await message.reply(f"âœ… **ØªÙ… Ø§Ù„ØªØ´ØºÙŠÙ„:** {title}")
                
        except NoActiveGroupCall:
            await msg.edit("âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙƒØ§Ù„Ù…Ø© Ù†Ø´Ø·Ø©! Ù‚Ù… Ø¨ÙØªØ­ Ø§Ù„ÙƒÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.")
        except AlreadyJoinedError:
            # Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©
            playlist.setdefault(chat_id, []).append(stream_link)
            titles.setdefault(chat_id, []).append(title)
            pos = len(playlist[chat_id])
            await msg.delete()
            await message.reply(f"âœ… **ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©** \nğŸ· Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: {title}\nğŸ”¢ Ø§Ù„Ù…Ø±ÙƒØ²: {pos}")
            
    except Exception as e:
        await msg.edit(f"âŒ Ø®Ø·Ø£: {e}")

@app.on_message(filters.command(["ØªØ®Ø·ÙŠ", "skip"], prefixes=["/", ""]) & filters.group)
async def skip_handler(client, message):
    if message.chat.id not in playing_now:
        return await message.reply("âŒ Ù…ÙÙŠØ´ Ø­Ø§Ø¬Ø© Ø´ØºØ§Ù„Ø©.")
    await message.reply("â­ ØªÙ… Ø§Ù„ØªØ®Ø·ÙŠ.")
    await play_next(message.chat.id)

@app.on_message(filters.command(["Ø§ÙŠÙ‚Ø§Ù", "Ø§Ù†Ù‡Ø§Ø¡", "stop"], prefixes=["/", ""]) & filters.group)
async def stop_handler(client, message):
    chat_id = message.chat.id
    if chat_id in playlist: playlist[chat_id].clear()
    if chat_id in titles: titles[chat_id].clear()
    
    try:
        await call_py.leave_group_call(chat_id)
        await message.reply("âœ… ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„.")
    except:
        await message.reply("âŒ Ø§Ù„Ø¨ÙˆØª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„ÙƒÙˆÙ„.")

# Ù…Ø¹Ø§Ù„Ø¬ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø£ØºÙ†ÙŠØ©
@call_py.on_stream_end()
async def stream_end_handler(client, update: Update):
    if isinstance(update, StreamAudioEnded):
        await play_next(update.chat_id)

# ==========================================
# ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª (Main Loop)
# ==========================================

async def main():
    print("ğŸš€ Ø¬Ø§Ø±ÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª...")
    await app.start()
    await call_py.start()
    print(f"âœ… ØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª: {app.me.first_name}")
    await idle()
    print("ğŸ›‘ Ø¬Ø§Ø±ÙŠ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨ÙˆØª...")
    await call_py.stop()
    await app.stop()

if __name__ == "__main__":
    loop = asyncio.get_event_loop()
    loop.run_until_complete(main())
